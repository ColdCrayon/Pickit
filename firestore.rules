rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ----- Helpers -----
    function isSignedIn() {
      return request.auth != null;
    }
    function mePath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }
    function hasMe() {
      return isSignedIn() && exists(mePath());
    }
    function getMe() {
      return get(mePath());
    }
    function isAdmin() {
      return hasMe() && getMe().data.isAdmin == true;
    }
    function isPremium() {
      return hasMe() && getMe().data.isPremium == true;
    }
    function isTicketOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    function canManageTicket(userId) {
      return isTicketOwner(userId) || isAdmin();
    }
    function validTicketData(userId, ticketId) {
      return request.resource.data.keys().hasOnly([
               'ticketId',
               'ticketType',
               'savedAt',
               'notificationSent',
               'userId'
             ]) &&
             request.resource.data.userId == userId &&
             request.resource.data.ticketId == ticketId;
    }
    // Ensure sensitive flags can't be changed by regular users
    function unchanged(field) {
      // If field not present in new data, treat as unchanged
      return !(field in request.resource.data) ||
             (field in resource.data && request.resource.data[field] == resource.data[field]);
    }

    // ----- Users: self read/write only; only admins can change flags -----
    match /users/{userId} {
      allow read:  if isSignedIn() && request.auth.uid == userId;
      allow write: if
        // User can update their own safe fields (email/username/etc.)
        (isSignedIn() && request.auth.uid == userId &&
         unchanged('isAdmin') && unchanged('isPremium'))
        ||
        // Admins can write any user doc (including setting flags)
        isAdmin();
      
      // NEW: Saved Tickets Subcollection
      match /savedTickets/{ticketId} {
        // Users can read/write their own saved tickets
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ----- Game Tickets -----
    match /gameTickets/{id} {
      // Read: admin OR premium OR (standard & settled)
      allow read: if isAdmin() || isPremium() || (isSignedIn() && resource.data.serverSettled == true);
      // Write: admin only
      allow write: if isAdmin();
    }

    // ----- Arbitrage Tickets -----
    match /arbTickets/{id} {
      // Read: admin OR premium OR (standard & settled)
      allow read: if isAdmin() || isPremium() || (isSignedIn() && resource.data.serverSettled == true);
      // Write: admin only
      allow write: if isAdmin();
    }

    // ----- Events Collection (from odds-ingestor) -----
    match /events/{eventId} {
      // Allow any signed-in user to read events
      allow read: if isSignedIn();
      // Only backend services can write (via admin SDK)
      allow write: if false;
      
      // Allow reading markets and books subcollections
      match /markets/{marketId} {
        allow read: if isSignedIn();
        allow write: if false;
        
        match /books/{bookId} {
          allow read: if isSignedIn();
          allow write: if false;
          
          // Allow reading snapshots subcollection
          match /snapshots/{snapshotId} {
            allow read: if isSignedIn();
            allow write: if false;
          }
        }
      }
    }

    // ----- Watchlists (User watchlist data) -----
    match /watchlists/{userId} {
      // Users can only read/write their own watchlist
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // ----- Articles Collection -----
    match /articles/{articleId} {
      // Anyone can read published articles
      allow read: if true;
      // Only admins can write articles
      allow write: if isAdmin();
    }

    // (No catch-all allows â€” default deny)
  }
}

